Meteor 语言内存管理总结

  根据代码分析，Meteor 采用了双引用计数 (Dual Reference Counting) 的内存管理方式。

  核心机制

  1. 对象头结构 (16 字节)
  ┌─────────────┬─────────────┬───────┬──────────┬──────────┐
  │ strong_rc   │ weak_rc     │ flags │ type_tag │ reserved │
  │ (u32)       │ (u32)       │ (u8)  │ (u8)     │ (u16)│
  └─────────────┴─────────────┴───────┴──────────┴──────────┘

  2. 引用计数操作 (builtins.py)
  | 函数                | 作用                      | 位置      |
  |---------------------|---------------------------|-----------|
  | meteor_retain       | 增加强引用                | 4595-4647 |
  | meteor_release      | 减少强引用，计数为0时销毁 | 4650-4746 |
  | meteor_weak_retain  | 增加弱引用                | 4749-4779 |
  | meteor_weak_release | 减少弱引用                | 4782-4831 |
  | meteor_weak_upgrade | 弱引用升级为强引用        | 4834-4882 |

  3. 托管类型 vs 值类型
  - 托管类型 (需要 RC): bigint, decimal, 数组, 类实例
  - 值类型 (栈分配): int, float, bool

  4. 作用域管理 (code_generator.py:2579-2617)
  - 进入作用域时注册托管变量
  - 退出作用域时自动调用 rc_release

  特色设计

  1. 冻结机制 (FLAG_IS_FROZEN): 冻结对象使用原子操作，支持并发安全
  2. 僵尸状态 (FLAG_IS_ZOMBIE): 对象销毁后保留头部供弱引用检查
  3. 入口块 alloca 缓存: 避免循环中重复栈分配

  这是一种类似 Swift ARC 的设计，通过强/弱引用分离来处理循环引用问题。