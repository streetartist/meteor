# Meteor HTTP Server Library
# æä¾› HTTP æœåŠ¡å™¨åŠŸèƒ½ï¼Œç”¨äºæ„å»º Web åº”ç”¨

@include("std/http")
@link("std/http/http_native")
import c "http_native.h"

# ============================================================================
# HTTP æ–¹æ³•æšä¸¾
# ============================================================================
pub enum HttpMethod
    GET
    POST
    PUT
    DELETE
    PATCH
    HEAD
    OPTIONS

# ============================================================================
# HTTP çŠ¶æ€ç æšä¸¾
# ============================================================================
pub enum HttpStatus
    OK                  # 200
    Created             # 201
    NoContent           # 204
    MovedPermanently    # 301
    Found               # 302
    NotModified         # 304
    BadRequest          # 400
    Unauthorized        # 401
    Forbidden           # 403
    NotFound            # 404
    MethodNotAllowed    # 405
    InternalError       # 500
    NotImplemented      # 501
    BadGateway          # 502
    ServiceUnavailable  # 503

# ============================================================================
# è¯·æ±‚å¤´
# ============================================================================
pub class Header
    name: str
    value: str

    def new(name: str, value: str)
        self.name = name
        self.value = value

# ============================================================================
# HTTP è¯·æ±‚
# ============================================================================
pub class Request
    method: HttpMethod
    path: str
    query: str
    body: str
    headers: list<Header>
    params: list<Header>  # è·¯ç”±å‚æ•°ï¼Œå¤ç”¨ Header ç»“æ„

    def new()
        self.method = HttpMethod.GET
        self.path = "/"
        self.query = ""
        self.body = ""
        self.headers = []
        self.params = []

    def get_header(name: str) -> str
        i = 0
        while i < self.headers.length()
            h = self.headers[i]
            if h.name == name
                return h.value
            i = i + 1
        return ""

    def get_param(name: str) -> str
        i = 0
        while i < self.params.length()
            p = self.params[i]
            if p.name == name
                return p.value
            i = i + 1
        return ""

    def content_type() -> str
        return self.get_header("Content-Type")

    def is_json() -> bool
        ct = self.content_type()
        return ct == "application/json"

# ============================================================================
# HTTP å“åº”
# ============================================================================
pub class Response
    status: HttpStatus
    headers: list<Header>
    body: str

    def new()
        self.status = HttpStatus.OK
        self.headers = []
        self.body = ""

    def set_status(status: HttpStatus) -> Response
        self.status = status
        return self

    def set_header(name: str, value: str) -> Response
        self.headers.append(Header(name, value))
        return self

    def set_body(body: str) -> Response
        self.body = body
        return self

    def content_type(ct: str) -> Response
        return self.set_header("Content-Type", ct)

    # ä¾¿æ·æ–¹æ³•ï¼šå‘é€ HTML
    def html(content: str) -> Response
        self.content_type("text/html; charset=utf-8")
        self.body = content
        return self

    # ä¾¿æ·æ–¹æ³•ï¼šå‘é€çº¯æ–‡æœ¬
    def text(content: str) -> Response
        self.content_type("text/plain; charset=utf-8")
        self.body = content
        return self

    # ä¾¿æ·æ–¹æ³•ï¼šå‘é€ JSON
    def json(content: str) -> Response
        self.content_type("application/json")
        self.body = content
        return self

    # ä¾¿æ·æ–¹æ³•ï¼šé‡å®šå‘
    def redirect(url: str) -> Response
        self.status = HttpStatus.Found
        self.set_header("Location", url)
        return self

    # ä¾¿æ·æ–¹æ³•ï¼š404 é”™è¯¯
    def not_found() -> Response
        self.status = HttpStatus.NotFound
        self.html("<h1>404 Not Found</h1>")
        return self

    # ä¾¿æ·æ–¹æ³•ï¼š500 é”™è¯¯
    def internal_error(message: str) -> Response
        self.status = HttpStatus.InternalError
        self.html("<h1>500 Internal Server Error</h1><p>" + message + "</p>")
        return self

# ============================================================================
# è·¯ç”±å¤„ç†å™¨ç±»å‹
# ============================================================================
pub class Route
    method: HttpMethod
    pattern: str
    handler: func<Request, Response> -> Response

    def new(method: HttpMethod, pattern: str, handler: func<Request, Response> -> Response)
        self.method = method
        self.pattern = pattern
        self.handler = handler

# ============================================================================
# ä¸­é—´ä»¶ç±»å‹
# ============================================================================
pub class Middleware
    handler: func<Request, Response, func> -> Response

    def new(handler: func<Request, Response, func> -> Response)
        self.handler = handler

# ============================================================================
# HTTP æœåŠ¡å™¨
# ============================================================================
pub class Server
    native_handle: c.MeteorHttpServer
    host: str
    port: int
    routes: list<Route>
    middlewares: list<Middleware>
    static_dir: str

    def new()
        self.native_handle = c.meteor_http_server_create()
        self.host = "127.0.0.1"
        self.port = 8080
        self.routes = []
        self.middlewares = []
        self.static_dir = ""

    # è®¾ç½®ç›‘å¬åœ°å€
    def bind(host: str, port: int) -> Server
        self.host = host
        self.port = port
        c.meteor_http_server_set_host(self.native_handle, host)
        c.meteor_http_server_set_port(self.native_handle, port)
        return self

    # æ³¨å†Œ GET è·¯ç”±
    def get(pattern: str, handler: func<Request, Response> -> Response) -> Server
        self.routes.append(Route(HttpMethod.GET, pattern, handler))
        return self

    # æ³¨å†Œ POST è·¯ç”±
    def post(pattern: str, handler: func<Request, Response> -> Response) -> Server
        self.routes.append(Route(HttpMethod.POST, pattern, handler))
        return self

    # æ³¨å†Œ PUT è·¯ç”±
    def put(pattern: str, handler: func<Request, Response> -> Response) -> Server
        self.routes.append(Route(HttpMethod.PUT, pattern, handler))
        return self

    # æ³¨å†Œ DELETE è·¯ç”±
    def delete(pattern: str, handler: func<Request, Response> -> Response) -> Server
        self.routes.append(Route(HttpMethod.DELETE, pattern, handler))
        return self

    # æ³¨å†Œä»»æ„æ–¹æ³•çš„è·¯ç”±
    def route(method: HttpMethod, pattern: str, handler: func<Request, Response> -> Response) -> Server
        self.routes.append(Route(method, pattern, handler))
        return self

    # æ·»åŠ ä¸­é—´ä»¶
    def use(middleware: Middleware) -> Server
        self.middlewares.append(middleware)
        return self

    # è®¾ç½®é™æ€æ–‡ä»¶ç›®å½•
    def static(dir: str) -> Server
        self.static_dir = dir
        c.meteor_http_server_set_static_dir(self.native_handle, dir)
        return self

    # å¯åŠ¨æœåŠ¡å™¨
    def listen() -> int
        c.meteor_http_server_bind(self.native_handle)
        
        while true
            conn = c.meteor_http_server_accept(self.native_handle)
            if conn == null
                continue
                
            req_ptr = c.meteor_http_connection_read_request(conn)
            if req_ptr != null
                # Convert to Meteor Request
                req = Request()
                
                # Method
                m_int = c.meteor_request_get_method(req_ptr)
                if m_int == 0; req.method = HttpMethod.GET
                else if m_int == 1; req.method = HttpMethod.POST
                else if m_int == 2; req.method = HttpMethod.PUT
                else if m_int == 3; req.method = HttpMethod.DELETE
                
                req.path = c.meteor_request_get_path(req_ptr)
                req.query = c.meteor_request_get_query(req_ptr)
                req.body = c.meteor_request_get_body(req_ptr)
                
                # Headers
                count = c.meteor_request_get_header_count(req_ptr)
                i = 0
                while i < count
                    name = c.meteor_request_get_header_name_at(req_ptr, i)
                    val = c.meteor_request_get_header_value_at(req_ptr, i)
                    req.headers.append(Header(name, val))
                    i = i + 1
                
                res = Response()
                
                # Dispatch
                handled = false
                i = 0
                while i < self.routes.length()
                    route = self.routes[i]
                    # Simple match (TODO: regex/params)
                    if route.pattern == req.path
                        # TODO: Check method
                        route.handler(req, res)
                        handled = true
                        break
                    i = i + 1
                
                if not handled
                    res.not_found()
                
                # Send response
                res_ptr = c.meteor_http_response_create()
                
                # Status
                status_code = 200
                if res.status == HttpStatus.OK; status_code = 200
                else if res.status == HttpStatus.NotFound; status_code = 404
                else if res.status == HttpStatus.InternalError; status_code = 500
                # ... others ...
                
                c.meteor_http_response_set_status(res_ptr, status_code)
                
                # Headers
                i = 0
                while i < res.headers.length()
                    h = res.headers[i]
                    c.meteor_http_response_set_header(res_ptr, h.name, h.value)
                    i = i + 1
                
                # Body
                c.meteor_http_response_set_body(res_ptr, res.body, res.body.length())
                
                c.meteor_http_connection_send_response(conn, res_ptr)
                c.meteor_http_response_free(res_ptr)
            
            c.meteor_http_connection_close(conn)
        return 0

    # åœæ­¢æœåŠ¡å™¨
    def stop()
        c.meteor_http_server_stop(self.native_handle)
        print("ğŸ›‘ Server stopped")

# ============================================================================
# ä¾¿æ·å·¥å‚å‡½æ•°
# ============================================================================
pub def create_server() -> Server
    return Server()

pub def create_request() -> Request
    return Request()

pub def create_response() -> Response
    return Response()
