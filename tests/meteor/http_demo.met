# HTTP Server ç¤ºä¾‹ç¨‹åº
# æ¼”ç¤º Meteor HTTP åº“çš„åŸºæœ¬ç”¨æ³•

@include("std/http")
@link("std/http/http_native")
import http.server
import c "time.h"

# æ•´æ•°è½¬å­—ç¬¦ä¸²è¾…åŠ©å‡½æ•°
def int_to_str(n: int) -> str
    if n == 0
        return "0"
    
    result = ""
    num = n
    is_neg = false
    
    if num < 0
        is_neg = true
        num = 0 - num
    
    while num > 0
        d = num % 10
        if d == 0
            result = "0" + result
        else if d == 1
            result = "1" + result
        else if d == 2
            result = "2" + result
        else if d == 3
            result = "3" + result
        else if d == 4
            result = "4" + result
        else if d == 5
            result = "5" + result
        else if d == 6
            result = "6" + result
        else if d == 7
            result = "7" + result
        else if d == 8
            result = "8" + result
        else
            result = "9" + result
        num = num / 10
    
    if is_neg
        result = "-" + result
    
    return result

# é¦–é¡µå¤„ç†å™¨
def home_handler(req: http.server.Request, res: http.server.Response) -> http.server.Response
    html = """
    <!DOCTYPE html>
    <html>
    <head>
        <title>Meteor HTTP Demo</title>
        <style>
            body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
            h1 { color: #6a5acd; }
            .links { margin-top: 20px; }
            .links a { margin-right: 15px; color: #4169e1; }
            code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
        </style>
    </head>
    <body>
        <h1>ğŸš€ Welcome to Meteor HTTP Server!</h1>
        <p>This is a demo page served by Meteor's HTTP library.</p>
        <div class="links">
            <h3>Try these endpoints:</h3>
            <ul>
                <li><a href="/hello">GET /hello</a> - Simple text response</li>
                <li><a href="/api/info">GET /api/info</a> - JSON API response</li>
                <li><a href="/api/time">GET /api/time</a> - Current time (JSON)</li>
            </ul>
        </div>
        <p><code>Powered by Meteor Language</code></p>
    </body>
    </html>
    """
    return res.html(html)

# Hello å¤„ç†å™¨
def hello_handler(req: http.server.Request, res: http.server.Response) -> http.server.Response
    return res.text("Hello from Meteor! ğŸŒŸ")

# API Info å¤„ç†å™¨
def api_info_handler(req: http.server.Request, res: http.server.Response) -> http.server.Response
    json_data = '{"name": "Meteor HTTP Server", "version": "1.0.0", "status": "running"}'
    return res.json(json_data)

# API Time å¤„ç†å™¨
def api_time_handler(req: http.server.Request, res: http.server.Response) -> http.server.Response
    # è·å–å½“å‰æ—¶é—´æˆ³
    timestamp: int = c.time(null)
    ts_str = int_to_str(timestamp)
    json_data = '{"timestamp": ' + ts_str + ', "message": "Current server time (Unix timestamp)"}'
    return res.json(json_data)

# ä¸»å‡½æ•°
def mymain()
    print("========================================")
    print("   Meteor HTTP Server Demo")
    print("========================================")
    
    # åˆ›å»ºæœåŠ¡å™¨
    server = http.server.create_server()
    
    # é…ç½®æœåŠ¡å™¨
    server.bind("127.0.0.1", 8080)
    
    # æ³¨å†Œè·¯ç”±
    server.get("/", home_handler)
    server.get("/hello", hello_handler)
    server.get("/api/info", api_info_handler)
    server.get("/api/time", api_time_handler)
    
    print("")
    print("Routes registered:")
    print("  GET /         -> Home page")
    print("  GET /hello    -> Text greeting")
    print("  GET /api/info -> Server info JSON")
    print("  GET /api/time -> Time JSON")
    print("")
    
    # å¯åŠ¨æœåŠ¡å™¨
    server.listen()

# è¿è¡Œ
mymain()
